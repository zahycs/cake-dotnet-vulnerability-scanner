using Cake.Frosting;
using Cake.VulnerabilityScanner;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace Build
{
    class Program
    {
        public static int Main(string[] args)
        {
            return new CakeHost()
                .Run(args);
        }
    }

    [TaskName("scan pacakges")]
    public sealed class ScanPackagesTask : AsyncFrostingTask<FrostingContext>
    {
        public override async Task RunAsync(FrostingContext context)
        {
            // SonaType token,  base64 username:password
            var ossIndexToken = context.Environment.GetEnvironmentVariable("OSS_INDEX_TOKEN");
            await context.ScanPackagesAsync(new ScanPackagesSettings
            {
                Ecosystem="nuget",
                FailOnVulnerability=true,
                OssIndexBaseUrl="https://ossindex.sonatype.org/",
                OssIndexToken=ossIndexToken,
                SolutionFile="../../../../../Cake.VulnerabilityScanner.sln",
                Verbosity= Microsoft.Extensions.Logging.LogLevel.Debug
            }, CancellationToken.None);
        }
    }

    [TaskName("Default")]
    [IsDependentOn(typeof(ScanPackagesTask))]
    public class DefaultTask : FrostingTask
    {
    }

}
